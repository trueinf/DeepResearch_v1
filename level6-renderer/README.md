# Level-6 Google Slides Renderer Microservice

This microservice renders high-quality PPTX files using Google Slides & Sheets APIs (Level 6).
It integrates with Supabase for job metadata and storage.

## Features

- ✅ Google Slides template copying and editing
- ✅ Placeholder text replacement
- ✅ Native Google Sheets chart creation and insertion
- ✅ Image insertion with proper positioning
- ✅ PPTX export and Supabase Storage upload
- ✅ Retry logic with exponential backoff
- ✅ Background job processing

## Quickstart

### 1. Prerequisites

- Python 3.11+
- Google Cloud service account with Slides/Sheets/Drive scopes
- Supabase project with `slide_jobs` table and `ppt-results` storage bucket

### 2. Setup Google Service Account

1. Go to [Google Cloud Console](https://console.cloud.google.com/)
2. Create a new project or select existing
3. Enable APIs:
   - Google Slides API
   - Google Sheets API
   - Google Drive API
4. Create Service Account:
   - IAM & Admin → Service Accounts → Create Service Account
   - Download JSON key file
5. Share your Slides template with the service account email

### 3. Configure Environment

```bash
cp .env.example .env
```

Fill in `.env`:
```env
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
SUPABASE_PPT_BUCKET=ppt-results
GCP_SERVICE_ACCOUNT_JSON=/path/to/gcp_sa.json
DEFAULT_TEMPLATE_DRIVE_ID=your_template_drive_file_id
LEVEL6_RENDERER_PORT=8080
```

### 4. Install Dependencies

```bash
pip install -r requirements.txt
```

### 5. Run Locally

```bash
uvicorn main:app --host 0.0.0.0 --port 8080
```

Or with Docker:

```bash
docker build -t level6-renderer .
docker run --env-file .env -p 8080:8080 level6-renderer
```

## API Endpoints

### POST /run-job

Process a slide job from Supabase.

**Request:**
```json
{
  "job_id": "uuid",
  "template_drive_id": "optional_template_id"
}
```

**Response:**
```json
{
  "status": "enqueued",
  "job_id": "uuid"
}
```

### GET /health

Health check endpoint.

**Response:**
```json
{
  "status": "ok"
}
```

## Deployment

### Google Cloud Run

```bash
gcloud builds submit --tag gcr.io/PROJECT_ID/level6-renderer
gcloud run deploy level6-renderer \
  --image gcr.io/PROJECT_ID/level6-renderer \
  --platform managed \
  --region us-central1 \
  --set-env-vars SUPABASE_URL=...,SUPABASE_SERVICE_ROLE_KEY=...
```

### Docker Compose

```yaml
version: '3.8'
services:
  level6-renderer:
    build: .
    env_file: .env
    ports:
      - "8080:8080"
```

## Integration with Supabase

1. Deploy the `create-ppt-job` Edge Function
2. Set `LEVEL6_RENDERER_WEBHOOK_URL` in Edge Function env vars
3. Frontend calls `/functions/v1/create-ppt-job` as usual
4. Edge Function creates job and calls webhook
5. Microservice processes job and updates `slide_jobs` table
6. Frontend polls `slide_jobs` for status updates

## Slide Plan Format

```json
{
  "slides": [
    {
      "layout": "title",
      "target_slide_index": 0,
      "placeholders": {
        "{{TITLE}}": "My Presentation",
        "{{SUBTITLE}}": "Generated by Level-6"
      }
    },
    {
      "layout": "content",
      "target_slide_index": 1,
      "placeholders": {
        "{{TITLE}}": "Key Findings",
        "{{CONTENT}}": "Point 1\nPoint 2\nPoint 3"
      },
      "chart_spec": {
        "title": "Revenue Growth",
        "data": [
          ["Quarter", "Revenue"],
          ["Q1", 120],
          ["Q2", 150]
        ],
        "series": [{"col": 1, "name": "Revenue"}],
        "x_col": 0,
        "x": 1.0,
        "y": 2.5,
        "width": 8.0,
        "height": 3.5
      }
    }
  ]
}
```

## Troubleshooting

### Service Account Permissions

Ensure the service account has:
- Viewer access to your template Slides file
- Editor access to create new files in Drive

### Supabase Storage

Ensure the `ppt-results` bucket exists and has public read access.

### Chart Creation

Charts require a Google Sheets spreadsheet. The service creates temporary spreadsheets that are cleaned up after chart insertion.

