# ðŸš€ Level-6 Setup - Quick Reference

Quick commands and snippets for setting up Level-6 integration.

## Step 1: Database Migration

### Via Dashboard
1. Supabase Dashboard â†’ SQL Editor
2. Paste contents of `supabase/migrations/20250120000000_create_slide_jobs.sql`
3. Click "Run"

### Via CLI
```bash
supabase migration up
```

### Verify
```sql
SELECT * FROM slide_jobs LIMIT 1;
SELECT * FROM storage.buckets WHERE id = 'ppt-results';
```

---

## Step 2: Deploy Edge Function

### Via Dashboard
1. Supabase Dashboard â†’ Edge Functions â†’ Create Function
2. Name: `create-ppt-job`
3. Paste code from `supabase/functions/create-ppt-job/index.ts`
4. Click "Deploy"

### Via CLI
```bash
supabase functions deploy create-ppt-job
```

### Test
```bash
curl -X POST https://YOUR_PROJECT.supabase.co/functions/v1/create-ppt-job \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"research_id":"test","slides":[{"layout":"title","title":"Test"}]}'
```

---

## Step 3: Google Service Account

### Quick Setup
1. **Google Cloud Console** â†’ Create Project
2. **Enable APIs:**
   - Google Slides API
   - Google Sheets API
   - Google Drive API
3. **IAM & Admin** â†’ Service Accounts â†’ Create
   - Name: `slides-renderer`
   - Create JSON key â†’ Download
4. **Google Slides** â†’ Create template with `{{TITLE}}`, `{{CONTENT}}` placeholders
5. **Share template** with service account email (Editor access)
6. **Copy template ID** from URL

### Store Credentials
```bash
mkdir -p level6-renderer/secrets
cp gcp_service_account.json level6-renderer/secrets/gcp_sa.json
```

---

## Step 4: Deploy Renderer

### Local (Docker)
```bash
cd level6-renderer
cp env.example .env
# Edit .env with your values
docker-compose up -d
```

### Local (Python)
```bash
cd level6-renderer
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate
pip install -r requirements.txt
uvicorn main:app --host 0.0.0.0 --port 8080
```

### Google Cloud Run
```bash
cd level6-renderer
gcloud builds submit --tag gcr.io/PROJECT_ID/level6-renderer
gcloud run deploy level6-renderer \
  --image gcr.io/PROJECT_ID/level6-renderer \
  --platform managed \
  --region us-central1 \
  --allow-unauthenticated \
  --set-env-vars SUPABASE_URL=...,SUPABASE_SERVICE_ROLE_KEY=...
```

### Test
```bash
curl http://localhost:8080/health
# Expected: {"status":"ok","service":"level6-renderer"}
```

---

## Step 5: Configure Webhook

### Via Dashboard
1. Supabase Dashboard â†’ Edge Functions â†’ `create-ppt-job` â†’ Settings
2. Add secret: `LEVEL6_RENDERER_WEBHOOK_URL` = `https://your-renderer-url/run-job`

### Via CLI
```bash
supabase secrets set LEVEL6_RENDERER_WEBHOOK_URL=https://your-renderer-url/run-job
```

---

## Environment Variables

### Edge Function (`create-ppt-job`)
```env
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
LEVEL6_RENDERER_WEBHOOK_URL=https://your-renderer-url/run-job  # Optional
```

### Level-6 Renderer
```env
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key
SUPABASE_PPT_BUCKET=ppt-results
GCP_SERVICE_ACCOUNT_JSON=./secrets/gcp_sa.json
DEFAULT_TEMPLATE_DRIVE_ID=your_template_id
LEVEL6_RENDERER_PORT=8080
```

---

## Quick Test Flow

### 1. Create Job
```bash
curl -X POST https://YOUR_PROJECT.supabase.co/functions/v1/create-ppt-job \
  -H "Authorization: Bearer TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "research_id": "test",
    "slides": [{
      "layout": "title",
      "title": "Test Presentation",
      "subtitle": "Generated by Level-6"
    }]
  }'
```

### 2. Check Job Status
```sql
SELECT id, status, final_ppt_url 
FROM slide_jobs 
ORDER BY created_at DESC 
LIMIT 1;
```

### 3. Process Job (if webhook not configured)
```bash
curl -X POST http://localhost:8080/run-job \
  -H "Content-Type: application/json" \
  -d '{"job_id": "job-id-from-step-1"}'
```

### 4. Download PPTX
```bash
# Get URL from step 2, then:
curl -O https://your-project.supabase.co/storage/v1/object/public/ppt-results/job-id.pptx
```

---

## Common Commands

### Check Edge Function Logs
```bash
supabase functions logs create-ppt-job
```

### Check Renderer Logs (Docker)
```bash
docker-compose logs -f level6-renderer
```

### Check Renderer Logs (Cloud Run)
```bash
gcloud run services logs read level6-renderer --limit 50
```

### List All Jobs
```sql
SELECT id, status, created_at, updated_at 
FROM slide_jobs 
ORDER BY created_at DESC;
```

### Check Failed Jobs
```sql
SELECT id, status, error_message, created_at 
FROM slide_jobs 
WHERE status = 'failed' 
ORDER BY created_at DESC;
```

---

## Troubleshooting Quick Fixes

### Database: Table doesn't exist
```sql
-- Re-run migration
\i supabase/migrations/20250120000000_create_slide_jobs.sql
```

### Edge Function: 401 Unauthorized
- Check token is valid
- Verify `verify_jwt = false` in `config.toml`

### Renderer: Can't access template
- Verify template is shared with service account email
- Check service account has Editor access
- Verify template ID is correct

### Renderer: Service won't start
```bash
# Check environment variables
cat .env

# Check service account file exists
ls -la secrets/gcp_sa.json

# Check logs
docker-compose logs level6-renderer
```

### Job stuck in "pending"
- Check webhook URL is correct
- Manually trigger: `curl -X POST http://renderer-url/run-job -d '{"job_id":"..."}'`
- Check renderer logs for errors

---

## File Locations

```
askDepth_gemini/
â”œâ”€â”€ supabase/
â”‚   â”œâ”€â”€ functions/
â”‚   â”‚   â””â”€â”€ create-ppt-job/
â”‚   â”‚       â””â”€â”€ index.ts          # Edge Function
â”‚   â”œâ”€â”€ migrations/
â”‚   â”‚   â””â”€â”€ 20250120000000_create_slide_jobs.sql
â”‚   â””â”€â”€ config.toml                # Function config
â”œâ”€â”€ level6-renderer/
â”‚   â”œâ”€â”€ main.py                    # FastAPI server
â”‚   â”œâ”€â”€ renderer.py                # Job processor
â”‚   â”œâ”€â”€ gdrive_helpers.py          # Google API
â”‚   â”œâ”€â”€ supabase_client.py         # Supabase client
â”‚   â”œâ”€â”€ requirements.txt           # Dependencies
â”‚   â”œâ”€â”€ Dockerfile                 # Docker build
â”‚   â”œâ”€â”€ docker-compose.yml         # Local dev
â”‚   â””â”€â”€ secrets/
â”‚       â””â”€â”€ gcp_sa.json            # Service account key
â””â”€â”€ LEVEL6_DETAILED_SETUP_GUIDE.md # Full guide
```

---

## Support Resources

- **Full Setup Guide:** `LEVEL6_DETAILED_SETUP_GUIDE.md`
- **Integration Guide:** `LEVEL6_INTEGRATION_GUIDE.md`
- **Renderer README:** `level6-renderer/README.md`
- **Quick Start:** `level6-renderer/QUICKSTART.md`

---

## Checklist

- [ ] Database migration run
- [ ] Edge Function deployed
- [ ] Google Service Account created
- [ ] Template created and shared
- [ ] Renderer deployed and running
- [ ] Webhook configured (optional)
- [ ] Test job created successfully
- [ ] Test job processed successfully
- [ ] PPTX downloaded and verified

---

**Need help?** Check the detailed guide: `LEVEL6_DETAILED_SETUP_GUIDE.md`

